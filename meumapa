<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Mapa Interativo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
      }

      #search-box {
        padding: 10px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 2;
      }

      input[type="text"] {
        padding: 5px;
        width: 70%;
        max-width: 300px;
      }

      button {
        padding: 5px 10px;
        margin-left: 5px;
      }

      #map {
        height: calc(100% - 60px);
        width: 100%;
        display: none; /* Oculto até localização ser carregada */
      }

      #confirmationModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }

      #modalContent {
        background-color: #fff;
        margin: 20% auto;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        text-align: center;
      }

      #modalContent button {
        padding: 8px 12px;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">Buscando sua localização. Aguarde...</div>

    <div id="search-box">
      <input type="text" id="addressInput" placeholder="Digite um endereço" />
      <button onclick="geocodeAddress()">Buscar</button>
    </div>
    <div id="map"></div>

    <div id="confirmationModal">
      <div id="modalContent">
        <p id="modalText"></p>
        <button id="confirmBtn">Sim</button>
        <button onclick="closeModal()">Não</button>
      </div>
    </div>

    <script>
      let map, marker, geocoder;
      let pendingAddress = "", pendingLink = "";

      function initMap() {
        const defaultLocation = { lat: -23.5505, lng: -46.6333 };

        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 18,
          mapTypeId: 'satellite',
        });

        geocoder = new google.maps.Geocoder();

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              map.setCenter(currentLocation);
              map.setZoom(20);
              setMarker(currentLocation);
              showMap();
            },
            (error) => {
              console.log("Erro ao obter localização:", error);
              showMap(); // Mesmo com erro, mostra o mapa
            },
            { enableHighAccuracy: true }
          );
        } else {
          showMap(); // Geolocalização não suportada
        }

        map.addListener("click", (e) => {
          const lat = e.latLng.lat();
          const lng = e.latLng.lng();
          const clickedLocation = { lat, lng };

          setMarker(clickedLocation);

          geocoder.geocode({ location: clickedLocation }, (results, status) => {
            if (status === "OK" && results[0]) {
              const address = results[0].formatted_address;
              const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
              pendingAddress = address;
              pendingLink = mapsLink;

              const text = `
                <strong>Endereço:</strong><br>${address}<br>
                <strong>Coordenadas:</strong><br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><br>
                Deseja continuar para o formulário?
              `;
              showModal(text);
            } else {
              alert("Não foi possível obter o endereço.");
            }
          });
        });
      }

      function showMap() {
        document.getElementById("loadingOverlay").style.display = "none";
        document.getElementById("map").style.display = "block";
      }

      function geocodeAddress() {
        const address = document.getElementById("addressInput").value;
        if (!address) return;

        geocoder.geocode({ address }, (results, status) => {
          if (status === "OK" && results[0]) {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(20);
            setMarker({ lat: location.lat(), lng: location.lng() });
          } else {
            alert("Endereço não encontrado.");
          }
        });
      }

      function setMarker(location) {
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: location, map: map });
      }

      function redirectToForm(address, link) {
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdDeJzlacQs4YQLyGtvl-3RZk7YCuabs3AK59b6po18yD2eNQ/viewform";
        const url = `${formUrl}?entry.685560023=${encodeURIComponent(address)}&entry.1482294369=${encodeURIComponent(link)}`;
        window.open(url, '_blank');
      }

      function showModal(text) {
        document.getElementById("modalText").innerHTML = text;
        document.getElementById("confirmationModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("confirmationModal").style.display = "none";
      }

      document.getElementById("confirmBtn").onclick = function () {
        closeModal();
        redirectToForm(pendingAddress, pendingLink);
      };

      window.initMap = initMap;
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap"
      async defer>
    </script>
  </body>
</html>
