<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Mapa Interativo</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #map {
        height: 90%;
        width: 100%;
      }
      #search-box {
        padding: 10px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 999;
      }
      input[type="text"] {
        padding: 5px;
        width: 300px;
      }
      button {
        padding: 5px 10px;
        margin-left: 5px;
      }

      #confirmationModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }

      #modalContent {
        background-color: #fff;
        margin: 20% auto;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        text-align: center;
      }

      #modalContent p {
        margin-bottom: 20px;
      }

      #modalContent button {
        padding: 8px 12px;
        margin: 0 10px;
      }
    </style>
  </head>
  <body>
    <div id="search-box">
      <input type="text" id="addressInput" placeholder="Digite um endereÃ§o" />
      <button onclick="geocodeAddress()">Buscar</button>
    </div>

    <div id="map"></div>

    <div id="confirmationModal">
      <div id="modalContent">
        <p id="modalText"></p>
        <button id="confirmBtn">Sim</button>
        <button onclick="closeModal()">NÃ£o</button>
      </div>
    </div>

    <script>
      let map, marker, geocoder;
      let pendingAddress = "", pendingLink = "";

      function initMap() {
        const defaultLocation = { lat: -23.5505, lng: -46.6333 }; // SP

        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 20,
          mapTypeId: "satellite",
          fullscreenControl: false,
        });

        geocoder = new google.maps.Geocoder();

        // âœ… BotÃ£o de localizaÃ§Ã£o do Maps
        const locationButton = document.createElement("button");
        locationButton.textContent = "ðŸ“ Minha localizaÃ§Ã£o";
        locationButton.classList.add("custom-map-control-button");
        locationButton.style.background = "#fff";
        locationButton.style.border = "2px solid #000";
        locationButton.style.padding = "5px";
        locationButton.style.margin = "10px";
        locationButton.style.cursor = "pointer";
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locationButton);

        locationButton.addEventListener("click", () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const pos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };
                map.setCenter(pos);
                map.setZoom(20);
                setMarker(pos);
              },
              () => {
                alert("Falha ao obter localizaÃ§Ã£o.");
              }
            );
          } else {
            alert("GeolocalizaÃ§Ã£o nÃ£o suportada.");
          }
        });

        // Evento de clique no mapa
        map.addListener("click", (e) => {
          const lat = e.latLng.lat();
          const lng = e.latLng.lng();
          const clickedLocation = { lat, lng };

          setMarker(clickedLocation);

          geocoder.geocode({ location: clickedLocation }, (results, status) => {
            if (status === "OK" && results[0]) {
              const address = results[0].formatted_address;
              const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;

              pendingAddress = address;
              pendingLink = mapsLink;

              const text = `
                <strong>EndereÃ§o:</strong><br>${address}<br>
                <strong>Coordenadas:</strong><br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><br>
                Deseja continuar para o formulÃ¡rio com essas informaÃ§Ãµes?
              `;
              showModal(text);
            } else {
              alert("NÃ£o foi possÃ­vel obter o endereÃ§o.");
            }
          });
        });
      }

      function geocodeAddress() {
        const address = document.getElementById("addressInput").value;
        if (!address) return;

        geocoder.geocode({ address }, (results, status) => {
          if (status === "OK" && results[0]) {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(20);
            setMarker({ lat: location.lat(), lng: location.lng() });
          } else {
            alert("EndereÃ§o nÃ£o encontrado.");
          }
        });
      }

      function setMarker(location) {
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: location, map: map });
      }

      function redirectToForm(address, link) {
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdDeJzlacQs4YQLyGtvl-3RZk7YCuabs3AK59b6po18yD2eNQ/viewform";
        const url = `${formUrl}?entry.685560023=${encodeURIComponent(address)}&entry.1482294369=${encodeURIComponent(link)}`;
        // ðŸ”— Abrir em nova aba
        window.open(url, "_blank");
      }

      function showModal(text) {
        document.getElementById("modalText").innerHTML = text;
        document.getElementById("confirmationModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("confirmationModal").style.display = "none";
      }

      document.getElementById("confirmBtn").onclick = function () {
        closeModal();
        redirectToForm(pendingAddress, pendingLink);
      };

      window.initMap = initMap;
    </script>

    <!-- Google Maps API -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_a0uSA8vj0JNKyci4RIrc12z0lNU_f4w&libraries=places&callback=initMap"
      async defer>
    </script>
  </body>
</html>
